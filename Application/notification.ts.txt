import { create, IndicatorColor } from '@openfin/workspace/notifications'
import { fin } from '@openfin/core'
import { v4 as uuidv4 } from 'uuid'
import { uniqueId } from 'lodash'

import { envConfig } from '@merlin-mfe/config'
import { EnvConfig, toTitleCase } from '@merlin-mfe/utils'
import { generateTraderNotificationTemplate } from './traderNotificationBaseTemplate'
import { LiveInquiryRecord, RawClosedInquiryRecord } from '@merlin-mfe/api'

const env: EnvConfig = envConfig

const IndicatorMapper: { [key: string]: { color: IndicatorColor; text: string } } = {
    ERROR: { color: IndicatorColor.RED, text: 'Error' },
    SUCCESS: { color: IndicatorColor.GREEN, text: 'Notification' },
    INFO: { color: IndicatorColor.BLUE, text: 'Info' }
}

export enum IndicatorType {
    'ERROR' = 'ERROR',
    'SUCCESS' = 'SUCCESS',
    'INFO' = 'INFO'
}

type TradeNotificationProps = {
    titleOne: string
    titleTwo: string
    firm: string
    customer: string
    settleDate: string
    closeTime: string
    coverPrice: string
    spread: string
    coverSpread: string | number
    market: string
    traderUser: string
    dv: string
    source: string
    benchmark: string
    benchmarkIsin: string | undefined
}

export const createTradeNotification = async (
    rfq: LiveInquiryRecord | RawClosedInquiryRecord,
    info: TradeNotificationProps,
    headerColor: string,
    sticky: boolean,
    isDark?: boolean
) => {
    const now = new Date() // Get the current time
    const midnight = new Date() // Get midnight time (next day at 00:00)
    midnight.setHours(24, 0, 0, 0) // Set the hours to 24:00 (which is equivalent to 00:00 of the next day)

    const baseTemplate = generateTraderNotificationTemplate(headerColor, isDark)

    await create({
        toast: sticky ? 'sticky' : 'transient',
        buttons: info.benchmarkIsin
            ? [
                  {
                      title: 'ALLQ BM',
                      type: 'button',
                      cta: true,
                      onClick: {
                          customData: {
                              action: 'open-benchmark',
                              benchmarkIsin: info.benchmarkIsin
                          }
                      }
                  },
                  {
                      title: 'Historical Ticket',
                      type: 'button',
                      cta: true,
                      onClick: {
                          customData: {
                              action: 'open-historical-ticket',
                              rfq: rfq
                          }
                      }
                  }
              ]
            : [
                  {
                      title: 'Historical Ticket',
                      type: 'button',
                      cta: true,
                      onClick: {
                          customData: {
                              action: 'open-historical-ticket',
                              rfq: rfq
                          }
                      }
                  }
              ],
        title: '',
        id: uniqueId(),
        platform: fin.me.uuid,
        icon: env?.OPENFIN_SERVER_BASE_URL ? `${env.OPENFIN_SERVER_BASE_URL}/favicon.png` : '',
        soundOptions: { mode: 'default' },
        stream: {
            id: fin.me.uuid,
            displayName: 'Merlin',
            appId: 'Merlin'
        },
        timeout: midnight.getTime() - now.getTime(), // Calculate the difference & Set the timeout in milliseconds
        template: 'custom',
        templateOptions: baseTemplate,
        templateData: {
            contentHeaderOne: info.titleOne,
            contentHeaderTwo: info.titleTwo,
            contentDate: info.settleDate,
            contentTime: info.closeTime,
            contentTraderUser: info.traderUser,
            contentClientName: info.firm,
            contentClientTrader: info.customer,
            contentDV: info.dv,
            contentSource: info.source,
            contentCoverPriceHeader: 'Cover Price',
            contentCoverPrice: info.coverPrice.toString(),
            contentSpreadHeader: 'Spread',
            contentSpread: info.spread.toString(),
            contentCoverSpreadHeader: 'Cover Spread',
            contentCoverSpread: info.coverSpread.toString(),
            contentMarketHeader: 'Market',
            contentMarket: info.market,
            contentBenchmark: info.benchmark
        }
    })
}

export const createNotification = async (notification: {
    indicator: { type: IndicatorType; text?: string }
    body: string
}) => {
    const {
        indicator: { type, text },
        body
    } = notification
    const now = new Date() // Get the current time
    const midnight = new Date() // Get midnight time (next day at 00:00)
    midnight.setHours(24, 0, 0, 0) // Set the hours to 24:00 (which is equivalent to 00:00 of the next day)

    await create({
        buttons: [],
        indicator: { color: IndicatorMapper[type].color, text: text ?? IndicatorMapper[type].text },
        title: '',
        body: body,
        id: uniqueId(),
        platform: fin.me.uuid,
        icon: env?.OPENFIN_SERVER_BASE_URL ? `${env.OPENFIN_SERVER_BASE_URL}/favicon.png` : '',
        soundOptions: { mode: 'default' },
        stream: {
            id: fin.me.uuid,
            displayName: 'Merlin',
            appId: 'Merlin'
        },
        timeout: midnight.getTime() - now.getTime() // Calculate the difference & Set the timeout in milliseconds
    })
}

const identity = {
    uuid: toTitleCase(fin.me.uuid?.replaceAll('-', ' ') ?? ''),
    name: toTitleCase(fin.me.name?.replaceAll('-', ' ') ?? '')
}

const PopupMessageMapper = (action: string, platformName: string): { title: string; desc: string } => {
    const mapper: { [key: string]: { title: string; desc: string } } = {
        resetWindowLayout: {
            title: `Reset ${identity.name} Layout`,
            desc: `Are you sure you want to replace existing ${identity.name} layout to default App layout.`
        },
        resetColumns: {
            title: 'Reset Columns',
            desc: `Are you sure you want to replace existing ${identity.name} Columns to default Column settings`
        },
        resetFilters: {
            title: 'Reset Filters',
            desc: `Are you sure you want to replace existing ${identity.name} Filters to default Filter settings`
        },
        resetSoundFilters: {
            title: 'Reset Sound Filters',
            desc: `Are you sure you want to replace existing ${identity.name} Sound Filters to default Sound settings`
        },
        resetQuoting: {
            title: 'Reset Quoting',
            desc: `Are you sure you want to replace existing ${identity.name} Quoting to default Quoting settings`
        },
        logout: {
            title: `Log Out of ${platformName}`,
            desc: `Are you sure you want to Log out of ${platformName}`
        }
    }

    return mapper[action]
}

export async function showPopup(
    isPlatform: boolean,
    action:
        | 'resetWindowLayout'
        | 'resetPlatformLayout'
        | 'resetColumns'
        | 'resetFilters'
        | 'resetSoundFilters'
        | 'resetQuoting'
        | 'logout',
    popupResultConfirmCallback: (payload: any) => Promise<void>
) {
    if (fin.me.isOpenFin) {
        const popupWidth = 400
        const popupHeight = 150
        let windowWidth
        let windowHeight

        if (fin.me.isWindow) {
            const win = fin.Window.getCurrentSync()
            const winState = await win.getState()

            if (isPlatform || winState === 'maximized') {
                windowWidth = window.screen.width
                windowHeight = window.screen.height
            } else {
                const bounds = await win.getBounds()
                windowWidth = bounds.width
                windowHeight = bounds.height
            }
        } else {
            const view = fin.View.getCurrentSync()
            const bounds = await view.getBounds()
            windowWidth = bounds.width
            windowHeight = bounds.height
        }

        const platformName = `[${env.REACT_NODE_ENV}] Front Office Apps - v${env.OPENFIN_PLATFORM_VERSION}`
        const x = windowWidth / 2 - popupWidth / 2 // Location and size of popup window derived from parent window bounds.
        const y = windowHeight / 2 - popupHeight / 2

        await fin.me.showPopupWindow({
            name: `modal-${uuidv4()}`,
            initialOptions: {
                showTaskbarIcon: false,
                defaultCentered: true,
                modalParentIdentity: fin.me.identity,
                // contextMenu: false,
                includeInSnapshots: false,
                preloadScripts: [
                    {
                        url: `${env?.OPENFIN_SERVER_BASE_URL}/common/style/style-changed-preload.js`
                    }
                ],
                customData: {
                    title: PopupMessageMapper(action, platformName).title,
                    message: PopupMessageMapper(action, platformName).desc,
                    buttons: [
                        {
                            label: 'Cancel',
                            value: 'cancel'
                        },
                        {
                            label: 'Confirm',
                            value: 'confirm'
                        }
                    ]
                }
            },
            x,
            y,
            width: popupWidth,
            height: popupHeight,
            url: `${env?.OPENFIN_SERVER_BASE_URL}/merlin/popups/dialog/index.html`,
            blurBehavior: 'modal',
            onPopupResult: async function (payload: any) {
                if (payload.result === 'clicked') {
                    if (payload.data.value === 'confirm') {
                        await popupResultConfirmCallback(payload)
                    }
                }
            }
        })
    }
}